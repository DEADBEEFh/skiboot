<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>P9 XIVE Exploitation &#8212; skiboot 5.5.0
 documentation</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '5.5.0
',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Secure and Truted Boot Overview" href="stb.html" />
    <link rel="prev" title="XSCOM Bindings" href="xscom-node-bindings.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="stb.html" title="Secure and Truted Boot Overview"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="xscom-node-bindings.html" title="XSCOM Bindings"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">skiboot 5.5.0
 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="p9-xive-exploitation">
<h1>P9 XIVE Exploitation<a class="headerlink" href="#p9-xive-exploitation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="i-device-tree-updates">
<h2>I - Device-tree updates<a class="headerlink" href="#i-device-tree-updates" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ol class="arabic">
<li><p class="first">The existing OPAL <code class="docutils literal"><span class="pre">/interrupt-controller&#64;0</span></code> node remains</p>
<p>This node represents both the emulated XICS source controller and
an abstraction of the virtualization engine. This represents the
fact thet OPAL set_xive/get_xive functions are still supported
though they don&#8217;t provide access to the full functionality.</p>
<p>It is still the parent of all interrupts in the device-tree.</p>
<p>New or modified properties:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">compatible</span></code> : This is extended with a new value <code class="docutils literal"><span class="pre">ibm,opal-xive-vc</span></code></li>
</ul>
</li>
<li><p class="first">The new <code class="docutils literal"><span class="pre">/interrupt-controller&#64;&lt;addr&gt;</span></code> node</p>
<p>This node represents both the emulated XICS presentation controller
and the new XIVE presentation layer.</p>
<p>Unlike the traditional XICS, there is only one such node for the whole
system.</p>
<p>New or modified properties:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">compatible</span></code> : This contains at least the following strings:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ibm,opal-intc</span></code> : This represents the emulated XICS presentation
facility and might be the only property present if the version of
OPAL doesn&#8217;t support XIVE exploitation.</li>
<li><code class="docutils literal"><span class="pre">ibm,opal-xive-pe</span></code> : This represents the XIVE presentation
engine.</li>
</ul>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ibm,xive-eq-sizes</span></code> : One cell per size supported, contains log2
of size, in ascending order.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ibm,xive-#priorities</span></code> : One cell, the number of supported priorities
(the priorities will be 0...n)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ibm,xive-provision-page-size</span></code> : Page size (in bytes) of the pages to
pass to OPAL for provisioning internal structures
(see opal_xive_donate_page). If this is absent, OPAL will never require
additional provisioning. The page must be naturally aligned.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">ibm,xive-provision-chips</span></code> : The list of chip IDs for which provisioning
is required. Typically, if a VP allocation return OPAL_XIVE_PROVISIONING,
opal_xive_donate_page() will need to be called to donate a page to
<em>each</em> of these chips before trying again.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">reg</span></code> property contains the addresses &amp; sizes for the register
ranges corresponding respectively to the 4 rings:</p>
<ul class="simple">
<li>Ultravisor level</li>
<li>Hypervisor level</li>
<li>Guest OS level</li>
<li>User level</li>
</ul>
<p>For any of these, a size of 0 means this level is not supported.</p>
</li>
</ul>
</li>
<li><p class="first">Interrupt descriptors</p>
<p>The interrupt descriptors (aka &#8220;interrupts&#8221; properties and parts
of &#8220;interrupt-map&#8221; properties) remain 2 cells. The first cell is
a global interrupt number which represents a unique interrupt
source in the system and is an abstraction provided by OPAL.</p>
<p>The default configuration for all sources in the IVT/EAS is to
issue that number (it&#8217;s internally a combination of the source
chip and per-chip interrupt number but the details of that
combination are not exposed and subject to change).</p>
<p>The second cell remains as usual &#8220;0&#8221; for an edge interrupt and
&#8220;1&#8221; for a level interrupts.</p>
</li>
<li><p class="first">IPIs</p>
<p>Each <code class="docutils literal"><span class="pre">cpu</span></code> node now contains an <code class="docutils literal"><span class="pre">interrupts</span></code> property which has
one entry (2 cells per entry) for each thread on that core
containing the interrupt number for the IPI targeted at that
thread.</p>
</li>
<li><p class="first">Interrupt targets</p>
<p>Targetting of interrupts uses processor targets and priority
numbers. The processor target encoding depends on which API is
used:</p>
<blockquote>
<div><ul class="simple">
<li>The legacy opal_set/get_xive() APIs only support the old
&#8220;mangled&#8221; (ie. shifted by 2) HW processor numbers.</li>
<li>The new opal_xive_set/get_irq_config API (and other
exploitation mode APIs) use a &#8220;token&#8221; VP number which is
described in II-2. Unmodified HW processor numbers are valid
VP numbers for those APIs.</li>
</ul>
</div></blockquote>
</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="ii-general-operations">
<h2>II - General operations<a class="headerlink" href="#ii-general-operations" title="Permalink to this headline">¶</a></h2>
<p>Most configuration operations are abstracted via OPAL calls, there is
no direct access or exposure of such things as real HW interrupt or VP
numbers.</p>
<p>OPAL sets up all the physical interrupts and assigns them numbers, it
also allocates enough virtual interrupts to provide an IPI per physical
thread in the system.</p>
<p>All interrupts are pre-configured masked and must be set to an explicit
target before first use. The default interrupt number is programmed
in the EAS and will remain unchanged if the targetting/unmasking is
done using the legacy set_xive() interface.</p>
<p>An interrupt &#8220;target&#8221; is a combination of a target processor number
and a priority.</p>
<p>Processor numbers are in a single domain that represents both the
physical processors and any virtual processor or group allocated
using the interfaces defined in this specification. These numbers
are an OPAL maintained abstraction and are only partially related
to the real VP numbers:</p>
<p>In order to maintain the grouping ability, when VPs are allocated
in blocks of naturally aligned powers of 2, the underlying HW
numbers will respect this alignment.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The block group mode extension makes the numbering scheme
a bit more tricky than simple powers of two however, see below.</p>
</div>
</div></blockquote>
<ol class="arabic">
<li><p class="first">Interrupt numbering and allocation</p>
<p>As specified in the device-tree definition, interrupt numbers
are abstracted by OPAL to be a 30-bit number. All HW interrupts
are &#8220;allocated&#8221; and configured at boot time along with enough
IPIs for all processor threads.</p>
<p>Additionally, in order to be compatible with the XICS emulation,
all interrupt numbers present in the device-tree (ie all physical
sources or pre-allocated IPIs) will fit within a 24-bit number
space.</p>
<p>Interrupt sources that are only usable in exploitation mode, such
as escalation interrupts, can have numbers covering the full 30-bit
range. The same is true of interrupts allocated dynamically.</p>
<p>The hypervisor can allocate additional blocks of interrupts,
in which case OPAL will return the resulting abstracted global
numbers. They will have to be individually configured to map
to a given number at the target and be routed to a given target
and priority using opal_xive_set_irq_config(). This call is
semantically equivalent to the old opal_set_xive() which is
still supported with the addition that opal_xive_set_irq_config()
can also specify the logical interrupt number.</p>
</li>
<li><p class="first">VP numbering and allocation</p>
<p>A VP number is a 64-bit number. The internal make-up of that number
is opaque to the OS. However, it is a discrete integer that will
be a naturally aligned power of two when allocating a chunk of
VPs representing the &#8220;base&#8221; number of that chunk, the OS will do
basic arithmetic to get to all the VPs in the range.</p>
<p>Groups, when supported, will also be numbers in that space.</p>
<p>The physical processors numbering uses the same number space.</p>
<p>The underlying HW VP numbering is hidden from the OS, the APIs
uses the system processor numbers as presented in the
<code class="docutils literal"><span class="pre">ibm,ppc-interrupt-server#s</span></code> which corresponds to the PIR register
content to represent physical processors within the same number
space as dynamically allocated VPs.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Note about block group mode:</p>
<p>The block group mode shall as much as possible be handled
transparently by OPAL.</p>
<p>For example, on a 2-chips machine, a request to allocate
2^n VPs might result in an allocation of 2^(n-1) VPs per
chip allocated accross 2 chips. The resulting VP numbers
will encode the order of the allocation allowing OPAL to
reconstitute which bits are the block ID bits and which bits
are the index bits in a way transparent to the OS. The overall
range of numbers passed to Linux will still be contiguous.</p>
<p class="last">That implies however a limitation: We can only allocate within
power-of-two number of blocks. Thus the VP allocator will limit
itself to the largest power of two that can fit in the number
of available chips in the machine: A machine with 3 good chips
will only be able to allocate VPs from 2 of them.</p>
</div>
</li>
<li><p class="first">Group numbering and allocation</p>
<p>The group numbers are in the <em>same</em> number space as the VP
numbers. OPAL will internally use some bits of the VP number
to encode the group geometry.</p>
<p>[TBD] OPAL may or may not allocate a default group of all physical
processors, per-chip groups or per-core groups. This will be
represented in the device-tree somewhat...</p>
<p>[TBD] OPAL will provide interfaces for allocating groups</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Note about P/Q bit operation on sources:</p>
<p>opal_xive_get_irq_info() returns a certain number of flags
which define the type of operation supported. The following
rules apply based on what those flags say:</p>
<ul class="last simple">
<li>The Q bit isn&#8217;t functional on an LSI interrupt. There is no
garantee that the special combination &#8220;01&#8221; will work for an
LSI (and in fact it will not work on the PHB LSIs). However
just setting P to 1 is sufficient to mask an LSI (just don&#8217;t
EOI it while masked).</li>
<li>The recommended setting for a masked interrupt that is
temporarily masked by a driver is &#8220;10&#8221;. This means a new
occurrence while masked will be recorded and a &#8220;StoreEOI&#8221;
will replay it appropriately.</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="section" id="iii-event-queues">
<h2>III - Event queues<a class="headerlink" href="#iii-event-queues" title="Permalink to this headline">¶</a></h2>
<p>Each virtual processor or group has a certain number of event queues
associated with it. Each correspond to a given priority. The number
of supported priorities is provided in the device-tree
(<code class="docutils literal"><span class="pre">ibm,xive-#priorities</span></code> property of the xive node).</p>
<p>By default, OPAL populates at least one queue for every physical thread
in the system. The number of queues and the size used is implementation
specific. If the OS wants to re-use these to save memory, it can query
the VP configuration.</p>
<p>The opal_xive_get_queue_info() and opal_xive_set_queue_info() can be used
to query a queue configuration (ie, to obtain the current page and size
for the queue itself, but also to collect some configuration flags for
that queue such as whether it coalesces notifications etc...) and to
obtain the MMIO address of the queue EOI page (in the case where
coalescing is enabled).</p>
</div>
<div class="section" id="iv-opal-apis">
<h2>IV - OPAL APIs<a class="headerlink" href="#iv-opal-apis" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><em>All</em> the calls listed below may return OPAL_BUSY unless
explicitely documented not to. In that case, the call
should be performed again. The OS is allowed to insert a
delay though no minimum nor maxmimum delay is specified.
This will typically happen when performing cache update
operations in the XIVE, if they result in a collision.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Calls that are expected to be called at runtime
simultaneously without conflicts such as getting/setting
IRQ info or queue info are fine to do so concurrently.</p>
<p>However, there is no internal locking to prevent races
between things such as freeing a VP block and getting/setting
queue infos on that block.</p>
<p class="last">These aren&#8217;t fully specified (yet) but common sense shall
apply.</p>
</div>
<div class="section" id="opal-xive-reset">
<h3>OPAL_XIVE_RESET<a class="headerlink" href="#opal-xive-reset" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="n">opal_xive_reset</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">version</span><span class="p">)</span>
</pre></div>
</div>
<p>The OS should call this once when starting up to re-initialize the
XIVE hardware and the OPAL XIVE related state back to all defaults.</p>
<p>It can call it a second time before handing over to another (ie.
kexec) to re-enable XICS emulation.</p>
<p>The &#8220;version&#8221; argument should be set to 1 to enable the XIVE
exploitation mode APIs or 0 to switch back to the default XICS
emulation mode.</p>
<p>Future versions of OPAL might allow higher versions than 1 to
represent newer versions of this API. OPAL will return an error
if it doesn&#8217;t recognize the requested version.</p>
<p>Any page of memory that the OS has &#8220;donated&#8221; to OPAL, either backing
store for EQDs or VPDs or actual queue buffers will be removed from
the various HW maps and can be re-used by the OS or freed after this
call regardless of the version information. The HW will be reset to
a (mostly) clean state.</p>
<p>It is the responsibility of the caller to ensure that no other
XIVE or XICS emulation call happens simultaneously to this. This
basically should happen on an otherwise quiescent system. In the
case of kexec, it is recommended that all processors CPPR is lowered
first.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This call always executes fully synchronously, never returns
OPAL_BUSY and will work regardless of whether VPs and EQs are left
enabled or disabled. It <em>will</em> spend a significant amount of time
inside OPAL and as such is not suitable to be performed during normal
runtime.</p>
</div>
</div>
<div class="section" id="opal-xive-get-irq-info">
<h3>OPAL_XIVE_GET_IRQ_INFO<a class="headerlink" href="#opal-xive-get-irq-info" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_get_irq_info</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">girq</span><span class="p">,</span>
                               <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">out_flags</span><span class="p">,</span>
                               <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">out_eoi_page</span><span class="p">,</span>
                               <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">out_trig_page</span><span class="p">,</span>
                               <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">out_esb_shift</span><span class="p">,</span>
                               <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">out_src_chip</span><span class="p">);</span>
</pre></div>
</div>
<p>Returns info about an interrupt source. This call never returns
OPAL_BUSY.</p>
<ul>
<li><p class="first">out_flags returns a set of flags. The following flags
are defined in the API (some bits are reserved, so any bit
not defined here should be ignored):</p>
<ul>
<li><p class="first">OPAL_XIVE_IRQ_TRIGGER_PAGE</p>
<p>Indicate that the trigger page is a separate page. If that
bit is clear, there is either no trigger page or the trigger
can be done in the same page as the EOI, see below.</p>
</li>
<li><p class="first">OPAL_XIVE_IRQ_STORE_EOI</p>
<p>Indicates that the interrupt supports the &#8220;Store EOI&#8221; option,
ie a store to the EOI page will move Q into P and retrigger
if the resulting P bit is 1. If this flag is 0, then a store
to the EOI page will do a trigger if OPAL_XIVE_IRQ_TRIGGER_PAGE
is also 0.</p>
</li>
<li><p class="first">OPAL_XIVE_IRQ_LSI</p>
<p>Indicates that the source is a level sensitive source and thus
doesn&#8217;t have a functional Q bit. The Q bit may or may not be
implemented in HW but SW shouldn&#8217;t rely on it doing anything.</p>
</li>
<li><p class="first">OPAL_XIVE_IRQ_SHIFT_BUG</p>
<p>Indicates that the source has a HW bug that shifts the bits
of the &#8220;offset&#8221; inside the EOI page left by 4 bits. So when
this is set, us 0xc000, 0xd000... instead of 0xc00, 0xd00...
as offets in the EOI page.</p>
</li>
<li><p class="first">OPAL_XIVE_IRQ_MASK_VIA_FW</p>
<p>Indicates that a FW call is needed (either opal_set_xive()
or opal_xive_set_irq_config()) to succesfully mask and unmask
the interrupt. The operations via the ESB page aren&#8217;t fully
functional.</p>
</li>
<li><p class="first">OPAL_XIVE_IRQ_EOI_VIA_FW</p>
<p>Indicates that a FW call to opal_xive_eoi() is needed to
successfully EOI the interrupt. The operation via the ESB page
isn&#8217;t fully functional.</p>
<ul class="simple">
<li>out_eoi_page and out_trig_page outputs will be set to the
EOI page physical address (always) and the trigger page address
(if it exists).
The trigger page may exist even if OPAL_XIVE_IRQ_TRIGGER_PAGE
is not set. In that case out_trig_page is equal to out_eoi_page.</li>
<li>out_esb_shift contains the size (as an order, ie 2^n) of the
EOI and trigger pages. Current supported values are 12 (4k)
and 16 (64k). Those cannot be configured by the OS and are set
by firmware but can be different for different interrupt sources.</li>
<li>out_src_chip will be set to the chip ID of the HW entity this
interrupt is sourced from. It&#8217;s meant to be informative only
and thus isn&#8217;t guaranteed to be 100% accurate. The idea is for
the OS to use that to pick up a default target processor on
the same chip.</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="opal-xive-eoi">
<h3>OPAL_XIVE_EOI<a class="headerlink" href="#opal-xive-eoi" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_eoi</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">girq</span><span class="p">);</span>
</pre></div>
</div>
<p>Performs an EOI on the interrupt. This should only be called if
OPAL_XIVE_IRQ_EOI_VIA_FW is set as otherwise direct ESB access
is preferred.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This is the <em>same</em> opal_xive_eoi() call used by OPAL XICS
emulation. However the XIRR parameter is re-purposed as &#8220;GIRQ&#8221;.</p>
<p class="last">The call will perform the appropriate function depending on
whether OPAL is in XICS emulation mode  or native XIVE exploitation
mode.</p>
</div>
</div>
<div class="section" id="opal-xive-get-irq-config">
<h3>OPAL_XIVE_GET_IRQ_CONFIG<a class="headerlink" href="#opal-xive-get-irq-config" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_get_irq_config</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">girq</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">out_vp</span><span class="p">,</span>
                                 <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">out_prio</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">out_lirq</span><span class="p">);</span>
</pre></div>
</div>
<p>Returns current the configuration of an interrupt source. This is
the equivalent of opal_get_xive() with the addition of the logical
interrupt number (the number that will be presented in the queue).</p>
<ul class="simple">
<li>girq: The interrupt number to get the configuration of as
provided by the device-tree.</li>
<li>out_vp: Will contain the target virtual processor where the
interrupt is currently routed to. This can return 0xffffffff
if the interrupt isn&#8217;t routed to a valid virtual processor.</li>
<li>out_prio: Will contain the priority of the interrupt or 0xff
if masked</li>
<li>out_lirq: Will contain the logical interrupt assigned to the
interrupt. By default this will be the same as girq.</li>
</ul>
</div>
<div class="section" id="opal-xive-set-irq-config">
<h3>OPAL_XIVE_SET_IRQ_CONFIG<a class="headerlink" href="#opal-xive-set-irq-config" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_set_irq_config</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">girq</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">vp</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">prio</span><span class="p">,</span>
                                 <span class="kt">uint32_t</span> <span class="n">lirq</span><span class="p">);</span>
</pre></div>
</div>
<p>This allows configuration and routing of a hardware interrupt. This is
equivalent to opal_set_xive() with the addition of the ability to
configure the logical IRQ number (the number that will be presented
in the target queue).</p>
<ul>
<li><p class="first">girq: The interrupt number to configure of as provided by the
device-tree.</p>
</li>
<li><p class="first">vp: The target virtual processor. The target VP/Prio combination
must already exist, be enabled and populated (ie, a queue page must
be provisioned for that queue).</p>
</li>
<li><p class="first">prio: The priority of the interrupt.</p>
</li>
<li><p class="first">lirq: The logical interrupt number assigned to that interrupt</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Note about masking:</p>
<p class="last">If the prio is set to 0xff, this call will cause the interrupt to be
masked.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This function might clobber the source P/Q bits. An interrupt
masked this way will be in a state where the events will be lost
while masked and not replayed while unmasked. Unkasking <em>will</em> clear
the state of the source P/Q bits unconditionally.</p>
</div>
<p>It is recommended for an OS exploiting the XIVE directly to not use
this function for temporary driver-initiated masking of interrupts
but to directly mask using the P/Q bits of the source instead.</p>
<p>Masking using this function is intended for the case where the OS has
no handler registered for a given interrupt anymore or when registering
a new handler for an interrupt that had none. In these case, losing
interrupts happening while no handler was attached is considered fine
and the source comes up in a &#8220;clean state&#8221; when used for the first time.</p>
</li>
</ul>
</div>
<div class="section" id="opal-xive-get-queue-info">
<h3>OPAL_XIVE_GET_QUEUE_INFO<a class="headerlink" href="#opal-xive-get-queue-info" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_get_queue_info</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">vp</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">prio</span><span class="p">,</span>
                                 <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">out_qpage</span><span class="p">,</span>
                                 <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">out_qsize</span><span class="p">,</span>
                                 <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">out_qeoi_page</span><span class="p">,</span>
                                 <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">out_escalate_irq</span><span class="p">,</span>
                                 <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">out_qflags</span><span class="p">);</span>
</pre></div>
</div>
<p>This returns informations about a given interrupt queue associated
with a virtual processor and a priority.</p>
<ul>
<li><p class="first">out_qpage: will contain the physical address of the page where the
interrupt events will be posted.</p>
</li>
<li><p class="first">out_qsize: will contain the log2 of the size of the queue buffer
or 0 if the queue hasn&#8217;t been populated. Example: 12 for a 4k page.</p>
</li>
<li><p class="first">out_qeoi_page: will contain the physical address of the MMIO page
used to perform EOIs for the queue notifications.</p>
</li>
<li><p class="first">out_escalate_irq: will contain a girq number for the escalation
interrupt associated with that queue.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The &#8220;escalate_irq&#8221; is a special interrupt number, depending
on the implementation it may or may not correspond to a normal
XIVE source.  Masking of escalation IRQs is only supported
using the PQ bits, passing a priority of 0xff to opal_set_xive or
opal_xive_set_irq_configuration() will in effect only affect
the PQ bits. Being MSIs though, they do support the special
&#8220;01&#8221; combination for &#8216;interrupt off&#8217;.</p>
</div>
</li>
<li><p class="first">out_qflags: will contain flags defined as follow:</p>
<ul>
<li><p class="first">OPAL_XIVE_EQ_ENABLED</p>
<p>This must be set for the queue to be enabled and thus a valid
target for interrupts. Newly allocated queues are disabled by
default and must be disabled again before being freed (allocating
and freeing of queues currently only happens along with their
owner VP).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A newly enabled queue will have the generation set to 1
and the queue pointer to 0. If the OS wants to &#8220;reset&#8221; a queue
generation and pointer, it thus must disable and re-enable
the queue.</p>
</div>
</li>
<li><p class="first">OPAL_XIVE_EQ_ALWAYS_NOTIFY</p>
<p>When this is set, the HW will always notify the VP on any new
entry in the queue, thus the queue own P/Q bits won&#8217;t be relevant
and using the EOI page will be unnecessary.</p>
</li>
<li><p class="first">OPAL_XIVE_EQ_ESCALATE</p>
<p>When this is set, the EQ will escalate to the escalation interrupt
when failing to notify.</p>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="opal-xive-set-queue-info">
<h3>OPAL_XIVE_SET_QUEUE_INFO<a class="headerlink" href="#opal-xive-set-queue-info" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_set_queue_info</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">vp</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">prio</span><span class="p">,</span>
                                 <span class="kt">uint64_t</span> <span class="n">qpage</span><span class="p">,</span>
                                 <span class="kt">uint64_t</span> <span class="n">qsize</span><span class="p">,</span>
                                 <span class="kt">uint64_t</span> <span class="n">qflags</span><span class="p">);</span>
</pre></div>
</div>
<p>This allows the OS to configure the queue page for a given processor
and priority and adjust the behaviour of the queue via flags.</p>
<ul>
<li><p class="first">qpage: physical address of the page where the interrupt events will
be posted. This has to be naturally aligned.</p>
</li>
<li><p class="first">qsize: log2 of the size of the above page. A 0 here will disable
the queue.</p>
</li>
<li><p class="first">qflags: Flags (see definitions in opal_xive_get_queue_info)</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Should this have the side effect of resetting the toggle/generation ?</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This must be called at least once on a queue with the flag
OPAL_XIVE_EQ_ENABLED in order to enable it after it has been
allocated (along with its owner VP).</p>
</div>
</li>
</ul>
</div>
<div class="section" id="opal-xive-donate-page">
<h3>OPAL_XIVE_DONATE_PAGE<a class="headerlink" href="#opal-xive-donate-page" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_donate_page</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">chip_id</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">);</span>
</pre></div>
</div>
<p>This call is used to donate pages to OPAL for use by VP/EQ provisioning.</p>
<p>The pages must be of the size specified by the &#8220;ibm,xive-provision-page-size&#8221;
property and naturally aligned.</p>
<p>All donated pages are forgotten by OPAL (and thus returned to the OS)
on any call to opal_xive_reset().</p>
<p>The chip_id should be the chip on which the pages were allocated or -1
if unspecified. Ideally, when a VP allocation request fails with the
OPAL_XIVE_PROVISIONING error, the OS should allocate one such page
for each chip in the system and hand it to OPAL before trying again.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is possible that the provisioning ends up requiring more than
one page per chip. OPAL will keep returning the above error until
enough pages have been provided.</p>
</div>
</div>
<div class="section" id="opal-xive-alloc-vp-block">
<h3>OPAL_XIVE_ALLOC_VP_BLOCK<a class="headerlink" href="#opal-xive-alloc-vp-block" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_alloc_vp_block</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">alloc_order</span><span class="p">);</span>
</pre></div>
</div>
<p>This call is used to allocate a block of VPs. It will return a number
representing the base of the block which will be aligned on the alloc
order, allowing the OS to do basic arithmetic to index VPs in the block.</p>
<p>The VPs will have queue structures reserved (but not initialized nor
provisioned) for all the priorities defined in the &#8220;ibm,xive-#priorities&#8221;
property</p>
<p>This call might return OPAL_XIVE_PROVISIONING. In this case, the OS
must allocate pages and provision OPAL using opal_xive_donate_page(),
see the documentation for opal_xive_donate_page() for details.</p>
<p>The resulting VPs must be individudally enabled with opal_xive_set_vp_info
below with the OPAL_XIVE_VP_ENABLED flag set before use.</p>
<p>For all priorities, the corresponding queues must also be individually
provisioned and enabled with opal_xive_set_queue_info.</p>
</div>
<div class="section" id="opal-xive-free-vp-block">
<h3>OPAL_XIVE_FREE_VP_BLOCK<a class="headerlink" href="#opal-xive-free-vp-block" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_free_vp_block</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">vp</span><span class="p">);</span>
</pre></div>
</div>
<p>This call is used to free a block of VPs. It must be called with the same
<em>base</em> number as was returned by opal_xive_alloc_vp() (any index into the
block will result in an OPAL_PARAMETER error).</p>
<p>The VPs must have been previously all disabled with opal_xive_set_vp_info
below with the OPAL_XIVE_VP_ENABLED flag cleared before use.</p>
<p>All the queues must also have been disabled.</p>
<p>Failure to do any of the above will result in an OPAL_XIVE_FREE_ACTIVE error.</p>
</div>
<div class="section" id="opal-xive-get-vp-info">
<h3>OPAL_XIVE_GET_VP_INFO<a class="headerlink" href="#opal-xive-get-vp-info" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_get_vp_info</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">vp</span><span class="p">,</span>
                              <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
                              <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">cam_value</span><span class="p">,</span>
                              <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">report_cl_pair</span><span class="p">,</span>
                              <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">chip_id</span><span class="p">);</span>
</pre></div>
</div>
<p>This call returns information about an allocated VP:</p>
<ul>
<li><p class="first">flags  :</p>
<ul>
<li><p class="first">OPAL_XIVE_VP_ENABLED</p>
<p>This must be set for the VP to be usable and cleared before freeing it</p>
</li>
</ul>
</li>
<li><p class="first">cam_value : This is the value to program into the thread management
area to dispatch that VP (ie, an encoding of the block + index).</p>
</li>
<li><p class="first">report_cl_pair:  This is the real address of the reporting cache line
pair for that VP (defaults to 0)</p>
</li>
<li><p class="first">chip_id : The chip that VCPU was allocated on</p>
</li>
</ul>
</div>
<div class="section" id="opal-xive-set-vp-info">
<h3>OPAL_XIVE_SET_VP_INFO<a class="headerlink" href="#opal-xive-set-vp-info" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_set_vp_info</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">vp</span><span class="p">,</span>
                              <span class="kt">uint64_t</span> <span class="n">flags</span><span class="p">,</span>
                              <span class="kt">uint64_t</span> <span class="n">report_cl_pair</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="opal-xive-allocate-irq">
<h3>OPAL_XIVE_ALLOCATE_IRQ<a class="headerlink" href="#opal-xive-allocate-irq" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_allocate_irq</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">chip_id</span><span class="p">);</span>
</pre></div>
</div>
<p>This call allocates a software IRQ on a given chip. It returns the
interrupt number or an error.</p>
</div>
<div class="section" id="opal-xive-free-irq">
<h3>OPAL_XIVE_FREE_IRQ<a class="headerlink" href="#opal-xive-free-irq" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">opal_xive_free_irq</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">girq</span><span class="p">);</span>
</pre></div>
</div>
<p>This call frees a software IRQ that was allocated by
opal_xive_allocate_irq. Passing any other interrupt number
will result in an OPAL_PARAMETER error.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">P9 XIVE Exploitation</a><ul>
<li><a class="reference internal" href="#i-device-tree-updates">I - Device-tree updates</a></li>
<li><a class="reference internal" href="#ii-general-operations">II - General operations</a></li>
<li><a class="reference internal" href="#iii-event-queues">III - Event queues</a></li>
<li><a class="reference internal" href="#iv-opal-apis">IV - OPAL APIs</a><ul>
<li><a class="reference internal" href="#opal-xive-reset">OPAL_XIVE_RESET</a></li>
<li><a class="reference internal" href="#opal-xive-get-irq-info">OPAL_XIVE_GET_IRQ_INFO</a></li>
<li><a class="reference internal" href="#opal-xive-eoi">OPAL_XIVE_EOI</a></li>
<li><a class="reference internal" href="#opal-xive-get-irq-config">OPAL_XIVE_GET_IRQ_CONFIG</a></li>
<li><a class="reference internal" href="#opal-xive-set-irq-config">OPAL_XIVE_SET_IRQ_CONFIG</a></li>
<li><a class="reference internal" href="#opal-xive-get-queue-info">OPAL_XIVE_GET_QUEUE_INFO</a></li>
<li><a class="reference internal" href="#opal-xive-set-queue-info">OPAL_XIVE_SET_QUEUE_INFO</a></li>
<li><a class="reference internal" href="#opal-xive-donate-page">OPAL_XIVE_DONATE_PAGE</a></li>
<li><a class="reference internal" href="#opal-xive-alloc-vp-block">OPAL_XIVE_ALLOC_VP_BLOCK</a></li>
<li><a class="reference internal" href="#opal-xive-free-vp-block">OPAL_XIVE_FREE_VP_BLOCK</a></li>
<li><a class="reference internal" href="#opal-xive-get-vp-info">OPAL_XIVE_GET_VP_INFO</a></li>
<li><a class="reference internal" href="#opal-xive-set-vp-info">OPAL_XIVE_SET_VP_INFO</a></li>
<li><a class="reference internal" href="#opal-xive-allocate-irq">OPAL_XIVE_ALLOCATE_IRQ</a></li>
<li><a class="reference internal" href="#opal-xive-free-irq">OPAL_XIVE_FREE_IRQ</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="xscom-node-bindings.html"
                        title="previous chapter">XSCOM Bindings</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="stb.html"
                        title="next chapter">Secure and Truted Boot Overview</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/xive.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="stb.html" title="Secure and Truted Boot Overview"
             >next</a> |</li>
        <li class="right" >
          <a href="xscom-node-bindings.html" title="XSCOM Bindings"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">skiboot 5.5.0
 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Stewart Smith, IBM, others.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
  </body>
</html>